<!DOCTYPE html>

<html lang="zh-CN"  class=" language_zh  heading_no_counter ">


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="keywords" content="">
    
    
    <meta name="description" content="">
    
    <meta name="generator" content="teedoc">
    <meta name="theme" content="teedoc-plugin-theme-default">
    
        
        <meta name="markdown-generator" content="teedoc-plugin-markdown-parser">
        
        <script>
MathJax = {"loader": {"load": ["output/svg"]}, "tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}, "svg": {"fontCache": "global"}};
</script>
        
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
        <script src="/static/js/theme_default/pre_main.js"></script>
        
        <link rel="stylesheet" href="/static/css/theme_default/prism.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/theme_default/viewer.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/theme_default/dark.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/theme_default/light.css" type="text/css"/>
        
        <script src="/static/js/theme_default/jquery.min.js"></script>
        
        <script src="/static/js/theme_default/split.js"></script>
        
        <link rel="stylesheet" href="/static/css/search/style.css" type="text/css"/>
        
        <meta name="blog-generator" content="teedoc-plugin-blog">
        
        <link rel="stylesheet" href="/static/css/custom.css" type="text/css"/>
        
    
    
    <title>xmake-docs</title>
    
    <script type="text/javascript">js_vars = {}</script>
    <script type="text/javascript">metadata = {"tags": [], "date": false, "update": [], "ts": 0, "author": "", "brief": "", "cover": "", "class": "heading_no_counter"}</script>
</head>


<body class="type_doc">
    
    <div id="navbar">
        <div id="navbar_menu">
            <a class="site_title" href="/">
                
                    <img class="site_logo" src="/static/image/logo-1600.png" alt="logo">
                
                
                    <h2>xmake</h2>
                
        </a>
            <a id="navbar_menu_btn"></a>
        </div>
        <div id="navbar_items">
            <div>
                <ul id="nav_left">
<li class=""><a  href="/get_started/zh/tutorial/quick-start.html">安装使用</a></li>
<li class=""><a  href="/dev/">开发文档</a></li>
</ul>

            </div>
            <div>
                <ul id="nav_right">
<li class=""><a target="_blank" href="https://github.com/zxmake/zxmake.github.io">github</a></li>
</ul>

                <ul class="nav_plugins"><li><a id="themes" class="light"></a></li></ul><ul class="nav_plugins"><li><a id="search"><span class="icon"></span><span class="placeholder">搜索</span>
                            <div id="search_hints">
                                <span id="search_input_hint">输入关键词，多关键词空格隔开</span>
                                <span id="search_loading_hint">正在加载，请稍候。。。</span>
                                <span id="search_download_err_hint">下载文件失败，请刷新重试或检查网络</span>
                                <span id="search_other_docs_result_hint">来自其它文档的结果</span>
                                <span id="search_curr_doc_result_hint">当前文档搜索结果</span>
                            </div></a></li></ul>
            </div>
        </div>
    </div>
    
    <div id="wrapper">
        <div id="sidebar_wrapper">
            <div id="sidebar">
                <div id="sidebar_title">
                    
                </div>
                <ul class="show">
<li class="not_active no_link sidebar_category"><span class="label">新手教程</span></li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/install.html"><span class="label">安装</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/quick-start.html"><span class="label">快速入门</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/get_started/zh/tutorial/syntax-description.html"><span class="label">语法描述</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/get_started/zh/tutorial/description-scope.html"><span class="label">描述域</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/project-examples.html"><span class="label">工程例子</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/configuration.html"><span class="label">配置说明</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/environment-variables.html"><span class="label">环境变量</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/build-policies.html"><span class="label">构建策略</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/builtin-variables.html"><span class="label">内置变量</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/FAQ.html"><span class="label">FAQ</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">target 编译目标</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/get_started/zh/target/description-scope.html"><span class="label">描述域</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/target/script-scope.html"><span class="label">脚本域</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">option 选项</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/get_started/zh/option/description-scope.html"><span class="label">描述域</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/option/script-scope.html"><span class="label">脚本域</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">package 包管理</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/get_started/zh/package/description-scope.html"><span class="label">描述域</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/package/script-scope.html"><span class="label">脚本域</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/package/local-package.html"><span class="label">使用本地包</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/package/remote-package.html"><span class="label">使用远程包</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/package/system-package.html"><span class="label">使用系统包</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/package/local-3rd-source-package.html"><span class="label">继承本地第三方源码库</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active with_link"><a href="/get_started/zh/rule/index.html"><span class="label">rule 规则</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/get_started/zh/rule/builtin-rules.html"><span class="label">内建规则</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/rule/description-scope.html"><span class="label">描述域</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">toolchain 工具链</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/get_started/zh/toolchain/builtin-toolchains.html"><span class="label">内置工具链</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/toolchain/custom-toolchains.html"><span class="label">自定义工具链</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/toolchain/remote-toolchains.html"><span class="label">远程工具链</span><span class=""></span></a></li>
</ul>
</li>
<li class="active_parent no_link"><a><span class="label">task 插件任务</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/get_started/zh/task/description-scope.html"><span class="label">描述域</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/task/plugin-development.html"><span class="label">插件开发</span><span class=""></span></a></li>
<li class="active with_link"><a href="/get_started/zh/task/builtin-plugins.html"><span class="label">内置插件</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">module 模块</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/get_started/zh/module/builtin-modules.html"><span class="label">内置模块</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/module/extension-modules.html"><span class="label">扩展模块</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/module/native-modules.html"><span class="label">Lua 原生模块</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">theme 主题风格</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/get_started/zh/theme/switch-themes.html"><span class="label">切换主题</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/theme/builtin-themes.html"><span class="label">内置主题</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active no_link"><a><span class="label">其他特性</span><span class="sub_indicator sub_indicator_collapsed"></span></a><ul class="">
<li class="not_active with_link"><a href="/get_started/zh/features/remote-build.html"><span class="label">远程编译</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/features/distcc-build.html"><span class="label">分布式编译</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/features/build-cache.html"><span class="label">编译缓存</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/features/unity-build.html"><span class="label">Unity 编译加速</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/features/autogen.html"><span class="label">自动扫描源码生成工程</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/features/try-build.html"><span class="label">尝试使用其他构建系统</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active with_link"><a href="/get_started/zh/xrepo/usage.html"><span class="label">xrepo 包管理器</span><span class=""></span></a></li>
</ul>

            </div>
        </div>
        <div id="article">
            <div id="menu_wrapper">
                <div id="menu">
                </div>
            </div>
            <div id="content_wrapper">
                <div id="content_body">
                    <div id="article_head">
                        <div id="article_title">
                            
                            <h1></h1>
                            
                        </div>
                        <div id="article_tags">
                            <ul>
                            
                            </ul>
                        </div>
                        <div id="article_info">
                        <div id="article_info_left">
                            <span class="article_author">
                                
                            </span>
                            
                        </div>
                        <div id="article_info_right">
                            
                            <div id="source_link">
                                <a href="https://github.com/TOMO-CAT/xmake-teedoc/docs/get_started/zh/task/builtin-plugins.md" target="_blank">
                                    编辑本页
                                </a>
                            </div>
                            
                        </div>
                        </div>
                    </div>
                    <div id="article_tools">
                        <span></span>
                        <span id="toc_btn"></span>
                    </div>
                    <div id="update_history">
                        
                    </div>
                    <div id="article_content">
                        
                            <h1 id="%E5%86%85%E7%BD%AE%E6%8F%92%E4%BB%B6">内置插件</h1>
<h2 id="%E7%94%9F%E6%88%90-IDE-%E5%B7%A5%E7%A8%8B%E6%96%87%E4%BB%B6">生成 IDE 工程文件</h2>
<h3 id="%E7%AE%80%E4%BB%8B">简介</h3>
<p>xmake 跟 <code>cmake</code>, <code>premake</code> 等其他一些构建工具的区别在于：</p>
<blockquote>
<p><code>xmake</code> 默认是直接构建运行的，生成第三方的 IDE 的工程文件仅仅作为 “插件” 来提供。</p>
</blockquote>
<p>这样做的一个好处是：插件更加容易扩展，维护也更加独立和方便。</p>
<h3 id="%E7%94%9F%E6%88%90-Makefile">生成 Makefile</h3>

<pre class="language-console"><code class="language-console">$ xmake project -k makefile
</code></pre>
<h3 id="%E7%94%9F%E6%88%90-CMakelists.txt">生成 CMakelists.txt</h3>

<pre class="language-console"><code class="language-console">$ xmake project -k cmakelists
</code></pre>
<h3 id="%E7%94%9F%E6%88%90-build.ninja">生成 build.ninja</h3>

<pre class="language-console"><code class="language-console">$ xmake project -k ninja
</code></pre>
<h3 id="%E7%94%9F%E6%88%90-compiler_flags">生成 compiler_flags</h3>

<pre class="language-console"><code class="language-console">$ xmake project -k compiler_flags
</code></pre>
<h3 id="%E7%94%9F%E6%88%90-compile_commands">生成 compile_commands</h3>
<p>导出每个源文件的编译信息，生成基于 clang 的编译数据库文件，json 格式，可用于跟 ide，编辑器，静态分析工具进行交互。</p>

<pre class="language-console"><code class="language-console">$ xmake project -k compile_commands
</code></pre>
<p>输出的内容格式如下：</p>

<pre class="language-none"><code class="language-none">[
  { &quot;directory&quot;: &quot;/home/user/llvm/build&quot;,
    &quot;command&quot;: &quot;/usr/bin/clang++ -Irelative -DSOMEDEF=\&quot;With spaces, quotes and \\-es.\&quot;-c -o file.o file.cc&quot;,
    &quot;file&quot;: &quot;file.cc&quot; },
  ...
]

</code></pre>
<p>对于 <code>compile_commands</code> 的详细说明见：<a href="#https://clang.llvm.org/docs/JSONCompilationDatabase.html"  target="_blank">JSONCompilationDatabase</a></p>
<h3 id="%E7%94%9F%E6%88%90-Xcode-%E5%B7%A5%E7%A8%8B%E6%96%87%E4%BB%B6">生成 Xcode 工程文件</h3>
<p>目前，我们还没有时间去自己实现 xcode 工程的生成，但不代表不支持，因为 xmake 支持生成 cmakelists.txt 文件，而 cmake 是支持 xcode 工程文件生成的，在官方还没有实现之前，<br />
我们也可以通过 cmake 变相支持它，xmake 会自动内部调用 cmake 中转下生成结果，对用户而言使用上没啥区别，只需要确保 cmake 已经安装即可：</p>

<pre class="language-console"><code class="language-console">$ xmake project -k xcode
</code></pre>
<h2 id="%E8%BF%90%E8%A1%8C%E8%87%AA%E5%AE%9A%E4%B9%89-lua-%E8%84%9A%E6%9C%AC">运行自定义 lua 脚本</h2>
<p>这个跟宏脚本类似，只是省去了导入导出操作，直接指定 lua 脚本来加载运行，这对于想要快速测试一些接口模块，验证自己的某些思路，都是一个不错的方式。</p>
<h3 id="%E8%BF%90%E8%A1%8C%E6%8C%87%E5%AE%9A%E7%9A%84%E8%84%9A%E6%9C%AC%E6%96%87%E4%BB%B6">运行指定的脚本文件</h3>
<p>我们先写个简单的 lua 脚本：</p>

<pre class="language-lua"><code class="language-lua">function main()
    print(&quot;hello xmake!&quot;)
end
</code></pre>
<p>然后直接运行它就行了：</p>

<pre class="language-console"><code class="language-console">$ xmake lua /tmp/test.lua
</code></pre>
<blockquote>
<p>当然，你也可以像宏脚本那样，使用 <code>import</code> 接口导入扩展模块，实现复杂的功能。</p>
</blockquote>
<h3 id="%E8%BF%90%E8%A1%8C%E5%86%85%E7%BD%AE%E7%9A%84%E8%84%9A%E6%9C%AC%E5%91%BD%E4%BB%A4">运行内置的脚本命令</h3>
<p>你可以运行 <code>xmake lua -l</code> 来列举所有内置的脚本名，例如：</p>

<pre class="language-console"><code class="language-console">$ xmake lua -l
scripts:
    cat
    cp
    echo
    versioninfo
    ...
</code></pre>
<p>并且运行它们：</p>

<pre class="language-console"><code class="language-console">$ xmake lua cat ~/file.txt
$ xmake lua echo &quot;hello xmake&quot;
$ xmake lua cp /tmp/file /tmp/file2
$ xmake lua versioninfo
</code></pre>
<h3 id="%E8%BF%90%E8%A1%8C%E4%BA%A4%E4%BA%92%E5%91%BD%E4%BB%A4-%28REPL%29">运行交互命令 (REPL)</h3>
<p>有时候在交互模式下，运行命令更加的方便测试和验证一些模块和 api，也更加的灵活，不需要再去额外写一个脚本文件来加载。</p>
<p>我们先看下，如何进入交互模式：</p>

<pre class="language-console"><code class="language-console"># 不带任何参数执行，就可以进入
$ xmake lua
&gt;

# 进行表达式计算
&gt; 1 + 2
3

# 赋值和打印变量值
&gt; a = 1
&gt; a
1

# 多行输入和执行
&gt; for _, v in pairs({1, 2, 3}) do
&gt;&gt; print(v)
&gt;&gt; end
1
2
3
</code></pre>
<p>我们也能够通过 <code>import</code> 来导入扩展模块：</p>

<pre class="language-console"><code class="language-console">&gt; task = import(&quot;core.project.task&quot;)
&gt; task.run(&quot;hello&quot;)
hello xmake!
</code></pre>
<p>如果要中途取消多行输入，只需要输入字符：<code>q</code> 就行了</p>

<pre class="language-console"><code class="language-console">&gt; for _, v in ipairs({1, 2}) do
&gt;&gt; print(v)
&gt;&gt; q             &lt;--  取消多行输入，清空先前的输入数据
&gt; 1 + 2
3
</code></pre>
<h2 id="%E6%98%BE%E7%A4%BA%E6%8C%87%E5%AE%9A%E4%BF%A1%E6%81%AF%E5%92%8C%E5%88%97%E8%A1%A8">显示指定信息和列表</h2>
<h3 id="%E6%98%BE%E7%A4%BA-xmake-%E8%87%AA%E8%BA%AB%E5%92%8C%E5%BD%93%E5%89%8D%E9%A1%B9%E7%9B%AE%E7%9A%84%E5%9F%BA%E7%A1%80%E4%BF%A1%E6%81%AF">显示 xmake 自身和当前项目的基础信息</h3>

<pre class="language-bash"><code class="language-bash">$ xmake show
The information of xmake:
    version: 2.3.3+202006011009
    host: macosx/x86_64
    programdir: /Users/ruki/.local/share/xmake
    programfile: /Users/ruki/.local/bin/xmake
    globaldir: /Users/ruki/.xmake
    tmpdir: /var/folders/32/w9cz0y_14hs19lkbs6v6_fm80000gn/T/.xmake501/200603
    workingdir: /Users/ruki/projects/personal/tbox
    packagedir: /Users/ruki/.xmake/packages
    packagedir(cache): /Users/ruki/.xmake/cache/packages/2006

The information of project: tbox
    version: 1.6.5
    plat: macosx
    arch: x86_64
    mode: release
    buildir: build
    configdir: /Users/ruki/projects/personal/tbox/.xmake/macosx/x86_64
    projectdir: /Users/ruki/projects/personal/tbox
    projectfile: /Users/ruki/projects/personal/tbox/xmake.lua
</code></pre>
<h3 id="%E6%98%BE%E7%A4%BA%E5%B7%A5%E5%85%B7%E9%93%BE%E5%88%97%E8%A1%A8">显示工具链列表</h3>

<pre class="language-bash"><code class="language-bash">$ xmake show -l toolchains
xcode         Xcode IDE
vs            VisualStudio IDE
yasm          The Yasm Modular Assembler
clang         A C language family frontend for LLVM
go            Go Programming Language Compiler
dlang         D Programming Language Compiler
sdcc          Small Device C Compiler
cuda          CUDA Toolkit
ndk           Android NDK
rust          Rust Programming Language Compiler
llvm          A collection of modular and reusable compiler and toolchain technologies
cross         Common cross compilation toolchain
nasm          NASM Assembler
gcc           GNU Compiler Collection
mingw         Minimalist GNU for Windows
gnu-rm        GNU Arm Embedded Toolchain
envs          Environment variables toolchain
fasm          Flat Assembler
</code></pre>
<h3 id="%E6%98%BE%E7%A4%BA%E6%8C%87%E5%AE%9A-target-%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF">显示指定 target 配置信息</h3>
<p>我们可以用它来快速追溯定位一些特定配置的位置。</p>

<pre class="language-bash"><code class="language-bash">$ xmake show -t tbox
The information of target(tbox):
    at: /Users/ruki/projects/personal/tbox/src/tbox/xmake.lua
    kind: static
    targetfile: build/macosx/x86_64/release/libtbox.a
    rules:
      -&gt; mode.release -&gt; ./xmake.lua:26
      -&gt; mode.debug -&gt; ./xmake.lua:26
      -&gt; mode.profile -&gt; ./xmake.lua:26
      -&gt; mode.coverage -&gt; ./xmake.lua:26
      -&gt; utils.install.cmake_importfiles -&gt; ./src/tbox/xmake.lua:15
      -&gt; utils.install.pkgconfig_importfiles -&gt; ./src/tbox/xmake.lua:16
    options:
      -&gt; info -&gt; ./src/tbox/xmake.lua:50
      -&gt; float -&gt; ./src/tbox/xmake.lua:50
      -&gt; wchar -&gt; ./src/tbox/xmake.lua:50
      -&gt; exception -&gt; ./src/tbox/xmake.lua:50
      -&gt; force-utf8 -&gt; ./src/tbox/xmake.lua:50
      -&gt; deprecated -&gt; ./src/tbox/xmake.lua:50
      -&gt; xml -&gt; ./src/tbox/xmake.lua:53
      -&gt; zip -&gt; ./src/tbox/xmake.lua:53
      -&gt; hash -&gt; ./src/tbox/xmake.lua:53
      -&gt; regex -&gt; ./src/tbox/xmake.lua:53
      -&gt; coroutine -&gt; ./src/tbox/xmake.lua:53
      -&gt; object -&gt; ./src/tbox/xmake.lua:53
      -&gt; charset -&gt; ./src/tbox/xmake.lua:53
      -&gt; database -&gt; ./src/tbox/xmake.lua:53
    packages:
      -&gt; mbedtls -&gt; ./src/tbox/xmake.lua:43
      -&gt; polarssl -&gt; ./src/tbox/xmake.lua:43
      -&gt; openssl -&gt; ./src/tbox/xmake.lua:43
      -&gt; pcre2 -&gt; ./src/tbox/xmake.lua:43
      -&gt; pcre -&gt; ./src/tbox/xmake.lua:43
      -&gt; zlib -&gt; ./src/tbox/xmake.lua:43
      -&gt; mysql -&gt; ./src/tbox/xmake.lua:43
      -&gt; sqlite3 -&gt; ./src/tbox/xmake.lua:43
    links:
      -&gt; pthread -&gt; option(__keyword_thread_local) -&gt; @programdir/includes/check_csnippets.lua:100
    syslinks:
      -&gt; pthread -&gt; ./xmake.lua:71
      -&gt; dl -&gt; ./xmake.lua:71
      -&gt; m -&gt; ./xmake.lua:71
      -&gt; c -&gt; ./xmake.lua:71
    defines:
      -&gt; __tb_small__ -&gt; ./xmake.lua:42
      -&gt; __tb_prefix__=&quot;tbox&quot; -&gt; ./src/tbox/xmake.lua:19
      -&gt; _GNU_SOURCE=1 -&gt; option(__systemv_semget) -&gt; @programdir/includes/check_cfuncs.lua:104
    cxflags:
      -&gt; -Wno-error=deprecated-declarations -&gt; ./xmake.lua:22
      -&gt; -fno-strict-aliasing -&gt; ./xmake.lua:22
      -&gt; -Wno-error=expansion-to-defined -&gt; ./xmake.lua:22
      -&gt; -fno-stack-protector -&gt; ./xmake.lua:51
    frameworks:
      -&gt; CoreFoundation -&gt; ./src/tbox/xmake.lua:38
      -&gt; CoreServices -&gt; ./src/tbox/xmake.lua:38
    mxflags:
      -&gt; -Wno-error=deprecated-declarations -&gt; ./xmake.lua:23
      -&gt; -fno-strict-aliasing -&gt; ./xmake.lua:23
      -&gt; -Wno-error=expansion-to-defined -&gt; ./xmake.lua:23
    includedirs:
      -&gt; src -&gt; ./src/tbox/xmake.lua:26
      -&gt; build/macosx/x86_64/release -&gt; ./src/tbox/xmake.lua:27
    headerfiles:
      -&gt; src/(tbox/**.h)|**/impl/**.h -&gt; ./src/tbox/xmake.lua:30
      -&gt; src/(tbox/prefix/**/prefix.S) -&gt; ./src/tbox/xmake.lua:31
      -&gt; src/(tbox/math/impl/*.h) -&gt; ./src/tbox/xmake.lua:32
      -&gt; src/(tbox/utils/impl/*.h) -&gt; ./src/tbox/xmake.lua:33
      -&gt; build/macosx/x86_64/release/tbox.config.h -&gt; ./src/tbox/xmake.lua:34
    files:
      -&gt; src/tbox/*.c -&gt; ./src/tbox/xmake.lua:56
      -&gt; src/tbox/hash/bkdr.c -&gt; ./src/tbox/xmake.lua:57
      -&gt; src/tbox/hash/fnv32.c -&gt; ./src/tbox/xmake.lua:57
      -&gt; src/tbox/hash/adler32.c -&gt; ./src/tbox/xmake.lua:57
      -&gt; src/tbox/math/**.c -&gt; ./src/tbox/xmake.lua:58
      -&gt; src/tbox/libc/**.c|string/impl/**.c -&gt; ./src/tbox/xmake.lua:59
      -&gt; src/tbox/utils/*.c|option.c -&gt; ./src/tbox/xmake.lua:60
      -&gt; src/tbox/prefix/**.c -&gt; ./src/tbox/xmake.lua:61
      -&gt; src/tbox/memory/**.c -&gt; ./src/tbox/xmake.lua:62
      -&gt; src/tbox/string/**.c -&gt; ./src/tbox/xmake.lua:63
      -&gt; src/tbox/stream/**.c|**/charset.c|**/zip.c -&gt; ./src/tbox/xmake.lua:64
      -&gt; src/tbox/network/**.c|impl/ssl/*.c -&gt; ./src/tbox/xmake.lua:65
      -&gt; src/tbox/algorithm/**.c -&gt; ./src/tbox/xmake.lua:66
      -&gt; src/tbox/container/**.c|element/obj.c -&gt; ./src/tbox/xmake.lua:67
      -&gt; src/tbox/libm/impl/libm.c -&gt; ./src/tbox/xmake.lua:68
      -&gt; src/tbox/libm/idivi8.c -&gt; ./src/tbox/xmake.lua:73
      -&gt; src/tbox/libm/ilog2i.c -&gt; ./src/tbox/xmake.lua:70
      -&gt; src/tbox/libm/isqrti.c -&gt; ./src/tbox/xmake.lua:71
      -&gt; src/tbox/libm/isqrti64.c -&gt; ./src/tbox/xmake.lua:72
      -&gt; src/tbox/platform/*.c|context.c|exception.c -&gt; ./src/tbox/xmake.lua:74
      -&gt; src/tbox/platform/impl/*.c|charset.c|poller_fwatcher.c -&gt; ./src/tbox/xmake.lua:74
      -&gt; src/tbox/libm/*.c -&gt; ./src/tbox/xmake.lua:77
    compiler (cc): /usr/bin/xcrun -sdk macosx clang
      -&gt; -Qunused-arguments -target x86_64-apple-macos12.6 -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.0.sdk
    linker (ar): /usr/bin/xcrun -sdk macosx ar
      -&gt; -cr
    compflags (cc):
      -&gt; -Qunused-arguments -target x86_64-apple-macos12.6 -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX13.0.sdk -Wall -Werror -Oz -std=c99 -Isrc -Ibuild/macosx/x86_64/release -D__tb_small__ -D__tb_prefix__=\&quot;tbox\&quot; -D_GNU_SOURCE=1 -framework CoreFoundation -framework CoreServices -Wno-error=deprecated-declarations -fno-strict-aliasing -Wno-error=expansion-to-defined -fno-stack-protector
    linkflags (ar):
      -&gt; -cr
</code></pre>
<h3 id="%E6%98%BE%E7%A4%BA%E5%86%85%E7%BD%AE%E7%BC%96%E8%AF%91%E6%A8%A1%E5%BC%8F%E5%88%97%E8%A1%A8">显示内置编译模式列表</h3>

<pre class="language-bash"><code class="language-bash">$ xmake show -l buildmodes
</code></pre>
<h3 id="%E6%98%BE%E7%A4%BA%E5%86%85%E7%BD%AE%E7%BC%96%E8%AF%91%E8%A7%84%E5%88%99%E5%88%97%E8%A1%A8">显示内置编译规则列表</h3>

<pre class="language-bash"><code class="language-bash">$ xmake show -l rules
</code></pre>
<h3 id="%E6%98%BE%E7%A4%BA%E5%85%B6%E4%BB%96%E4%BF%A1%E6%81%AF">显示其他信息</h3>
<p>还在完善中，详情见：<a href="https://github.com/xmake-io/xmake/issues/798"  target="_blank">https://github.com/xmake-io/xmake/issues/798</a></p>
<p>或者运行：</p>

<pre class="language-bash"><code class="language-bash">$ xmake show --help
</code></pre>
<h2 id="%E7%9B%91%E8%A7%86%E6%96%87%E4%BB%B6%E6%9B%B4%E6%96%B0">监视文件更新</h2>
<p><code>xmake watch</code> 插件命令可以自动监视项目文件更新，然后触发自动构建，或者运行一些自定义命令。</p>
<p>这通常用于个人开发时候，实现快速的实时增量编译，而不需要每次手动执行编译命令，提高开发效率。</p>
<h3 id="%E9%A1%B9%E7%9B%AE%E6%9B%B4%E6%96%B0%E5%90%8E%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA">项目更新后自动构建</h3>
<p>默认行为就是监视整个项目根目录，任何文件改动都会触发项目的增量编译。</p>

<pre class="language-bash"><code class="language-bash">$ xmake watch
watching /private/tmp/test/src/** ..
watching /private/tmp/test/* ..
/private/tmp/test/src/main.cpp modified
[25%]: cache compiling.release src/main.cpp
[50%]: linking.release test
[100%]: build ok!
</code></pre>
<h3 id="%E7%9B%91%E8%A7%86%E6%8C%87%E5%AE%9A%E7%9B%AE%E5%BD%95">监视指定目录</h3>
<p>我们也可以监视指定的代码目录，缩小监视范围，提升监视性能。</p>

<pre class="language-bash"><code class="language-bash">$ xmake watch -d src
$ xmake watch -d &quot;src;tests/*&quot;
</code></pre>
<p>上面的命令，会去递归监视所有子目录，如果想要紧紧监视当前目录下的文件，不进行递归监视，可以使用下面的命令。</p>

<pre class="language-bash"><code class="language-bash">$ xmake watch -p src
$ xmake watch -p &quot;src;tests/*&quot;
</code></pre>
<h3 id="%E7%9B%91%E8%A7%86%E5%B9%B6%E8%BF%90%E8%A1%8C%E6%8C%87%E5%AE%9A%E5%91%BD%E4%BB%A4">监视并运行指定命令</h3>
<p>如果想在自动构建后，还想自动运行构建的程序，我们可以使用自定义的命令集。</p>

<pre class="language-bash"><code class="language-bash">$ xmake watch -c &quot;xmake; xmake run&quot;
</code></pre>
<p>上面的命令列表是作为字符串传递，这对于复杂命令参数，需要转义比较繁琐不够灵活，那么我们可以使用下面的方式进行任意命令的设置。</p>

<pre class="language-bash"><code class="language-bash">$ xmake watch -- echo hello xmake!
$ xmake watch -- xmake run --help
</code></pre>
<h3 id="%E7%9B%91%E8%A7%86%E5%B9%B6%E8%BF%90%E8%A1%8C%E7%9B%AE%E6%A0%87%E7%A8%8B%E5%BA%8F">监视并运行目标程序</h3>
<p>尽管我们可以通过自定义命令来实现目标程序的自动运行，但是我们也提供了更加方便的参数来实现这个行为。</p>

<pre class="language-bash"><code class="language-bash">$ xmake watch -r
$ xmake watch --run
[100%]: build ok!
hello world!
</code></pre>
<h3 id="%E7%9B%91%E8%A7%86%E5%B9%B6%E8%BF%90%E8%A1%8C-lua-%E8%84%9A%E6%9C%AC">监视并运行 lua 脚本</h3>
<p>我们还可以监视文件更新后，运行指定的 lua 脚本，实现更加灵活复杂的命令定制。</p>

<pre class="language-bash"><code class="language-bash">$ xmake watch -s /tmp/test.lua
</code></pre>
<p>我们还可以再脚本中获取所有更新的文件路径列表和事件。</p>

<pre class="language-lua"><code class="language-lua">function main(events)
    -- TODO handle events
end
</code></pre>
<h2 id="%E5%88%86%E6%9E%90%E8%AF%8A%E6%96%AD%E5%B7%A5%E7%A8%8B%E9%85%8D%E7%BD%AE%E5%92%8C%E4%BB%A3%E7%A0%81">分析诊断工程配置和代码</h2>
<h3 id="%E6%A3%80%E6%B5%8B%E5%B7%A5%E7%A8%8B%E9%85%8D%E7%BD%AE">检测工程配置</h3>
<h4 id="%E9%BB%98%E8%AE%A4%E6%A3%80%E6%B5%8B%E6%89%80%E6%9C%89-API">默认检测所有 API</h4>

<pre class="language-lua"><code class="language-lua">set_lanuages(&quot;c91&quot;) -- typo
</code></pre>

<pre class="language-console"><code class="language-console">$ xmake check
./xmake.lua:15: warning: unknown language value 'c91', it may be 'c90'
0 notes, 1 warnings, 0 errors
</code></pre>
<p>默认也可以指定检测特定组：</p>

<pre class="language-console"><code class="language-console">$ xmake check api
$ xmake check api.target
</code></pre>
<h4 id="%E6%98%BE%E7%A4%BA%E8%AF%A6%E7%BB%86%E8%BE%93%E5%87%BA">显示详细输出</h4>
<p>这会额外提供 note 级别的检测信息。</p>

<pre class="language-console"><code class="language-console">$ xmake check -v
./xmake.lua:15: warning: unknown language value 'cxx91', it may be 'cxx98'
./src/tbox/xmake.lua:43: note: unknown package value 'mbedtls'
./src/tbox/xmake.lua:43: note: unknown package value 'polarssl'
./src/tbox/xmake.lua:43: note: unknown package value 'openssl'
./src/tbox/xmake.lua:43: note: unknown package value 'pcre2'
./src/tbox/xmake.lua:43: note: unknown package value 'pcre'
./src/tbox/xmake.lua:43: note: unknown package value 'zlib'
./src/tbox/xmake.lua:43: note: unknown package value 'mysql'
./src/tbox/xmake.lua:43: note: unknown package value 'sqlite3'
8 notes, 1 warnings, 0 errors
</code></pre>
<h4 id="%E6%A3%80%E6%B5%8B%E6%8C%87%E5%AE%9A%E7%9A%84-API">检测指定的 API</h4>

<pre class="language-console"><code class="language-console">$ xmake check api.target.languages
./xmake.lua:15: warning: unknown language value 'cxx91', it may be 'cxx98'
0 notes, 1 warnings, 0 errors
</code></pre>
<h4 id="%E6%A3%80%E6%B5%8B%E7%BC%96%E8%AF%91-flags">检测编译 flags</h4>

<pre class="language-console"><code class="language-console">$ xmake check
./xmake.lua:10: warning: clang: unknown c compiler flag '-Ox'
0 notes, 1 warnings, 0 errors
</code></pre>
<h4 id="%E6%A3%80%E6%B5%8B-includedirs">检测 includedirs</h4>
<p>除了 includedirs，还有 linkdirs 等路径都会去检测。</p>

<pre class="language-console"><code class="language-console">$ xmake check
./xmake.lua:11: warning: includedir 'xxx' not found
0 notes, 1 warnings, 0 errors
</code></pre>
<h3 id="%E6%A3%80%E6%B5%8B%E5%B7%A5%E7%A8%8B%E4%BB%A3%E7%A0%81%EF%BC%88clang-tidy%EF%BC%89">检测工程代码（clang-tidy）</h3>
<h4 id="%E6%98%BE%E7%A4%BA-clang-tidy-%E6%A3%80%E6%B5%8B%E5%88%97%E8%A1%A8">显示 clang-tidy 检测列表</h4>

<pre class="language-console"><code class="language-console">$ xmake check clang.tidy --list
Enabled checks:
    clang-analyzer-apiModeling.StdCLibraryFunctions
    clang-analyzer-apiModeling.TrustNonnull
    clang-analyzer-apiModeling.google.GTest
    clang-analyzer-apiModeling.llvm.CastValue
    clang-analyzer-apiModeling.llvm.ReturnValue
    ...
</code></pre>
<h4 id="%E6%A3%80%E6%B5%8B%E6%89%80%E6%9C%89-targets-%E4%B8%AD%E7%9A%84%E6%BA%90%E7%A0%81">检测所有 targets 中的源码</h4>

<pre class="language-console"><code class="language-console">$ xmake check clang.tidy
1 error generated.
Error while processing /private/tmp/test2/src/main.cpp.
/tmp/test2/src/main.cpp:1:10: error: 'iostr' file not found [clang-diagnostic-error]
#include &lt;iostr&gt;
         ^~~~~~~
Found compiler error(s).
error: execv(/usr/local/opt/llvm/bin/clang-tidy -p compile_commands.json /private/tmp/test2/src
/main.cpp) failed(1)
</code></pre>
<h4 id="%E6%8C%87%E5%AE%9A%E6%A3%80%E6%B5%8B%E7%B1%BB%E5%9E%8B">指定检测类型</h4>
<p>我们可以在 <code>--check=</code> 中指定需要检测的类型，具体用法可以参考 <code>clang-tidy</code> 的 <code>--check=</code> 参数，完全一致的。</p>

<pre class="language-console"><code class="language-console">$ xmake check clang.tidy --checks=&quot;*&quot;
6 warnings and 1 error generated.
Error while processing /private/tmp/test2/src/main.cpp.
/tmp/test2/src/main.cpp:1:10: error: 'iostr' file not found [clang-diagnostic-error]
#include &lt;iostr&gt;
         ^~~~~~~
/tmp/test2/src/main.cpp:3:1: warning: do not use namespace using-directives; use using-declarat
ions instead [google-build-using-namespace]
using namespace std;
^
/tmp/test2/src/main.cpp:3:17: warning: declaration must be declared within the '__llvm_libc' na
mespace [llvmlibc-implementation-in-namespace]
using namespace std;
                ^
/tmp/test2/src/main.cpp:5:5: warning: declaration must be declared within the '__llvm_libc' nam
espace [llvmlibc-implementation-in-namespace]
int main(int argc, char **argv) {
    ^
/tmp/test2/src/main.cpp:5:5: warning: use a trailing return type for this function [modernize-u
se-trailing-return-type]
int main(int argc, char **argv) {
~~~ ^
auto                            -&gt; int
/tmp/test2/src/main.cpp:5:14: warning: parameter 'argc' is unused [misc-unused-parameters]
int main(int argc, char **argv) {
             ^~~~
              /*argc*/
/tmp/test2/src/main.cpp:5:27: warning: parameter 'argv' is unused [misc-unused-parameters]
int main(int argc, char **argv) {
                          ^~~~
                           /*argv*/
Found compiler error(s).
error: execv(/usr/local/opt/llvm/bin/clang-tidy --checks=* -p compile_commands.json /private/tm
p/test2/src/main.cpp) failed(1)
</code></pre>
<h4 id="%E6%A3%80%E6%B5%8B%E6%8C%87%E5%AE%9A-target-%E7%9A%84%E4%BB%A3%E7%A0%81">检测指定 target 的代码</h4>

<pre class="language-console"><code class="language-console">$ xmake check clang.tidy [targetname]
</code></pre>
<h4 id="%E6%A3%80%E6%B5%8B%E7%BB%99%E5%AE%9A%E7%9A%84%E6%BA%90%E6%96%87%E4%BB%B6%E5%88%97%E8%A1%A8">检测给定的源文件列表</h4>

<pre class="language-console"><code class="language-console">$ xmake check clang.tidy -f src/main.c
$ xmake check clang.tidy -f 'src/*.c:src/**.cpp'
</code></pre>
<h4 id="%E8%AE%BE%E7%BD%AE-.clang-tidy-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">设置 .clang-tidy 配置文件</h4>

<pre class="language-console"><code class="language-console">$ xmake check clang.tidy --configfile=/tmp/.clang-tidy
</code></pre>
<h4 id="%E5%88%9B%E5%BB%BA-.clang-tidy-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">创建 .clang-tidy 配置文件</h4>

<pre class="language-console"><code class="language-console">$ xmake check clang.tidy --checks=&quot;*&quot; --create
$ cat .clang-tidy
---
Checks:          'clang-diagnostic-*,clang-analyzer-*,*'
WarningsAsErrors: ''
HeaderFilterRegex: ''
AnalyzeTemporaryDtors: false
FormatStyle:     none
User:            ruki
CheckOptions:
  - key:             readability-suspicious-call-argument.PrefixSimilarAbove
    value:           '30'
  - key:             cppcoreguidelines-no-malloc.Reallocations
    value:           '::realloc'

</code></pre>
<h4 id="%E8%87%AA%E5%8A%A8%E4%BF%AE%E5%A4%8D%E9%94%99%E8%AF%AF%E4%BB%A3%E7%A0%81">自动修复错误代码</h4>
<p>我们可以使用下面的命令参数，自动修复 clang tidy 检测出来的问题代码。</p>

<pre class="language-console"><code class="language-console">$ xmake check clang.tidy --fix
$ xmake check clang.tidy --fix_errors
$ xmake check clang.tidy --fix_notes
</code></pre>
<h2 id="%E7%94%9F%E6%88%90%E5%AE%89%E8%A3%85%E5%8C%85-%28XPack%29">生成安装包 (XPack)</h2>
<h3 id="%E7%AE%80%E4%BB%8B">简介</h3>
<p>这个插件可以帮助用户快速生成不同平台的安装包，源码包，它会生成下面一些安装包格式：</p>
<ul>
<li>Windows NSIS 二进制安装包</li>
<li>Windows WIX 二进制安装包</li>
<li>runself (shell) 自编译安装包</li>
<li>zip/tar.gz 二进制包</li>
<li>zip/tar.gz 源码包</li>
<li>RPM 二进制安装包</li>
<li>SRPM 源码安装包</li>
<li>DEB 二进制安装包</li>
</ul>
<p>下面是一个完整例子，我们可以先简单看下：</p>

<pre class="language-lua"><code class="language-lua">set_version(&quot;1.0.0&quot;)
add_rules(&quot;mode.debug&quot;, &quot;mode.release&quot;)

includes(&quot;@builtin/xpack&quot;)

target(&quot;test&quot;)
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.cpp&quot;)

xpack(&quot;test&quot;)
    set_formats(&quot;nsis&quot;, &quot;zip&quot;, &quot;targz&quot;, &quot;runself&quot;)
    set_title(&quot;hello&quot;)
    set_author(&quot;ruki&quot;)
    set_description(&quot;A test installer.&quot;)
    set_homepage(&quot;https://xmake.io&quot;)
    set_licensefile(&quot;LICENSE.md&quot;)
    add_targets(&quot;test&quot;)
    add_installfiles(&quot;src/(assets/*.png)&quot;, {prefixdir = &quot;images&quot;})
    add_sourcefiles(&quot;(src/**)&quot;)
    set_iconfile(&quot;src/assets/xmake.ico&quot;)

    after_installcmd(function (package, batchcmds)
        batchcmds:mkdir(package:installdir(&quot;resources&quot;))
        batchcmds:cp(&quot;src/assets/*.txt&quot;, package:installdir(&quot;resources&quot;), {rootdir = &quot;src&quot;})
        batchcmds:mkdir(package:installdir(&quot;stub&quot;))
    end)

    after_uninstallcmd(function (package, batchcmds)
        batchcmds:rmdir(package:installdir(&quot;resources&quot;))
        batchcmds:rmdir(package:installdir(&quot;stub&quot;))
    end)
</code></pre>
<p>我们通过 <code>includes(&quot;@builtin/xpack&quot;)</code> 引入 xpack 的所有配置接口，包括 xpack 配置域，以及它的所有域接口。</p>
<p>然后我们执行：</p>

<pre class="language-bash"><code class="language-bash">$ xmake pack
</code></pre>
<p>即可生成所有安装包。</p>
<h3 id="%E7%94%9F%E6%88%90-NSIS-%E5%AE%89%E8%A3%85%E5%8C%85">生成 NSIS 安装包</h3>
<p>只要配置了 <code>set_formats(&quot;nsis&quot;)</code> 格式，然后执行 <code>xmake pack</code> 命令，就能生成 NSIS 格式的安装包。</p>
<p>另外，xmake 还会自动安装生成 NSIS 包所需的工具，实现真正的一键打包。</p>

<pre class="language-bash"><code class="language-bash">$ xmake pack
note: install or modify (m) these packages (pass -y to skip confirm)?
in xmake-repo:
  -&gt; nsis 3.09
please input: y (y/n/m)

  =&gt; install nsis 3.09 .. ok

[25%]: compiling.release src\main.cpp
[37%]: compiling.release src\main.cpp
[50%]: linking.release foo.dll
[62%]: linking.release test.exe
packing build\xpack\test\test-windows-x64-v1.0.0.exe
pack ok
</code></pre>
<p><code>test-windows-x64-v1.0.0.exe</code> 就是我们生成的安装包，双击运行它，就能安装我们的二进制文件到指定目录。</p>
<p><img src="/assets/img/manual/nsis_1.png" alt="" /><br />
<img src="/assets/img/manual/nsis_2.png" alt="" /><br />
<img src="/assets/img/manual/nsis_3.png" alt="" /></p>
<h4 id="%E5%A2%9E%E5%8A%A0%E7%BB%84%E4%BB%B6%E5%AE%89%E8%A3%85">增加组件安装</h4>
<p>我们还可以给 NSIS 增加组件安装命令，只有当用户选择指定组件的时候，它的安装命令才会被执行。</p>

<pre class="language-lua"><code class="language-lua">xpack(&quot;test&quot;)
    add_components(&quot;LongPath&quot;)

xpack_component(&quot;LongPath&quot;)
    set_default(false)
    set_title(&quot;Enable Long Path&quot;)
    set_description(&quot;Increases the maximum path length limit, up to 32,767 characters (before 256).&quot;)
    on_installcmd(function (component, batchcmds)
        batchcmds:rawcmd(&quot;nsis&quot;, [[
  ${If} $NoAdmin == &quot;false&quot;
    ; Enable long path
    WriteRegDWORD ${HKLM} &quot;SYSTEM\CurrentControlSet\Control\FileSystem&quot; &quot;LongPathsEnabled&quot; 1
  ${EndIf}]])
    end)
</code></pre>
<p>这个例子中，我们在里面添加了一个 NSIS 特有的自定义命令，去实现对长路径的支持。</p>
<p><img src="/assets/img/manual/nsis_4.png" alt="" /></p>
<h3 id="%E7%94%9F%E6%88%90%E8%87%AA%E5%AE%89%E8%A3%85%E5%8C%85">生成自安装包</h3>
<p>我们也可以生成基于 shell 脚本的自编译安装包。我们需要配置 runself 打包格式，然后通过 <code>add_sourcefiles</code> 添加需要参与编译安装的源文件。</p>
<p>接着，我们需要自定义 on_installcmd 安装脚本，里面去配置如果编译源码包，我们可以简单的调用一个内置的编译安装脚本文件，也可以直接配置 <code>make install</code> 等编译安装命令。</p>
<p>例如：</p>

<pre class="language-lua"><code class="language-lua">xpack(&quot;test&quot;)
    set_formats(&quot;runself&quot;)
    add_sourcefiles(&quot;(src/**)&quot;)
    on_installcmd(function (package, batchcmds)
        batchcmds:runv(&quot;make&quot;, {&quot;install&quot;})
    end)
</code></pre>
<p>然后，我们执行 <code>xmake pack</code> 命令，就可以生成一个自安装的 xxx.gz.run 包，默认采用 gzip 压缩。</p>

<pre class="language-bash"><code class="language-bash">$ xmake pack
packing build/xpack/test/test-macosx-src-v1.0.0.gz.run
pack ok
</code></pre>
<p>我们可以使用 sh 去加载运行它来安装我们的程序。</p>

<pre class="language-bash"><code class="language-bash">$ sh ./build/xpack/test/test-macosx-src-v1.0.0.gz.run
</code></pre>
<p>我们也可以看一个比较完整的例子：</p>

<pre class="language-lua"><code class="language-lua">xpack(&quot;xmakesrc&quot;)
    set_formats(&quot;runself&quot;)
    set_basename(&quot;xmake-v$(version)&quot;)
    set_prefixdir(&quot;xmake-$(version)&quot;)
    before_package(function (package)
        import(&quot;devel.git&quot;)

        local rootdir = path.join(os.tmpfile(package:basename()) .. &quot;.dir&quot;, &quot;repo&quot;)
        if not os.isdir(rootdir) then
            os.tryrm(rootdir)
            os.cp(path.directory(os.projectdir()), rootdir)

            git.clean({repodir = rootdir, force = true, all = true})
            git.reset({repodir = rootdir, hard = true})
            if os.isfile(path.join(rootdir, &quot;.gitmodules&quot;)) then
                git.submodule.clean({repodir = rootdir, force = true, all = true})
                git.submodule.reset({repodir = rootdir, hard = true})
            end
        end

        local extraconf = {rootdir = rootdir}
        package:add(&quot;sourcefiles&quot;, path.join(rootdir, &quot;core/**|src/pdcurses/**|src/luajit/**|src/tbox/tbox/src/demo/**&quot;), extraconf)
        package:add(&quot;sourcefiles&quot;, path.join(rootdir, &quot;xmake/**&quot;), extraconf)
        package:add(&quot;sourcefiles&quot;, path.join(rootdir, &quot;*.md&quot;), extraconf)
        package:add(&quot;sourcefiles&quot;, path.join(rootdir, &quot;configure&quot;), extraconf)
        package:add(&quot;sourcefiles&quot;, path.join(rootdir, &quot;scripts/*.sh&quot;), extraconf)
        package:add(&quot;sourcefiles&quot;, path.join(rootdir, &quot;scripts/man/**&quot;), extraconf)
        package:add(&quot;sourcefiles&quot;, path.join(rootdir, &quot;scripts/debian/**&quot;), extraconf)
        package:add(&quot;sourcefiles&quot;, path.join(rootdir, &quot;scripts/msys/**&quot;), extraconf)
    end)

    on_installcmd(function (package, batchcmds)
        batchcmds:runv(&quot;./scripts/get.sh&quot;, {&quot;__local__&quot;})
    end)
</code></pre>
<p>它是 xmake 自身源码的安装包配置脚本，更完整的配置可以参考：<a href="https://github.com/xmake-io/xmake/blob/master/core/xpack.lua"  target="_blank">xpack.lua</a></p>
<p>这里，它通过调用源码包内置的 <code>./scripts/get.sh</code> 安装脚本去执行编译安装。</p>
<h3 id="%E7%94%9F%E6%88%90%E6%BA%90%E7%A0%81%E5%BD%92%E6%A1%A3%E5%8C%85">生成源码归档包</h3>
<p>另外，我们也可以配置 <code>srczip</code> 和 <code>srctargz</code> 格式，来生成源码压缩包，它不是完整的安装包，也没有安装命令，仅仅用于源码包分发。</p>

<pre class="language-lua"><code class="language-lua">xpack(&quot;test&quot;)
    set_formats(&quot;srczip&quot;, &quot;srctargz&quot;)
    add_sourcefiles(&quot;(src/**)&quot;)
</code></pre>

<pre class="language-bash"><code class="language-bash">$ xmake pack
packing build/xpack/test/test-macosx-src-v1.0.0.zip ..
packing build/xpack/test/test-macosx-src-v1.0.0.tar.gz ..
pack ok
</code></pre>
<h3 id="%E7%94%9F%E6%88%90%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%BD%92%E6%A1%A3%E5%8C%85">生成二进制归档包</h3>
<p>我们也可以配置 <code>zip</code> 和 <code>targz</code> 来生成二进制的压缩包，它会先自动编译所有绑定的 target 目标程序，将所有需要的二进制程序，库文件打包到 zip/tar.gz 格式。</p>
<p>这通常用于制作绿色版的安装包，内部不太任何自动安装脚本，用户需要自己设置 PATH 等环境变量。</p>

<pre class="language-lua"><code class="language-lua">xpack(&quot;test&quot;)
    set_formats(&quot;zip&quot;, &quot;targz&quot;)
    add_installfiles(&quot;(src/**)&quot;)
</code></pre>

<pre class="language-bash"><code class="language-bash">$ xmake pack
packing build/xpack/test/test-macosx-v1.0.0.zip ..
packing build/xpack/test/test-macosx-v1.0.0.tar.gz ..
pack ok
</code></pre>
<p>!&gt; 需要注意的是，打二进制文件到包里，使用的是 <code>add_installfiles</code> 而不是 <code>add_sourcefiles</code>。</p>
<p>我们也可以通过 <code>add_targets</code> 去绑定需要安装的 target 目标程序和库。更多详情见下面关于 <code>add_targets</code> 的接口描述。</p>
<h3 id="%E7%94%9F%E6%88%90-SRPM-%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%E5%8C%85">生成 SRPM 源码安装包</h3>
<p>它可以生成 <code>.src.rpm</code> 格式的源码安装包。</p>
<p>我们可以通过配置 add_targets 关联需要构建的目标，在生成的 srpm 包中，它会自动调用 <code>xmake build</code> 和 <code>xmake install</code> 去构建和安装包。</p>

<pre class="language-lua"><code class="language-lua">xpack(&quot;test&quot;)
    set_homepage(&quot;https://xmake.io&quot;)
    set_license(&quot;Apache-2.0&quot;)
    set_description(&quot;A cross-platform build utility based on Lua.&quot;)

    set_formats(&quot;srpm&quot;)
    add_sourcefiles(&quot;(src/**)&quot;)
    add_sourcefiles(&quot;./xmake.lua&quot;)

    add_targets(&quot;demo&quot;)
</code></pre>
<p>它会生成类似下面的 spec 文件，然后自动调用 rpmbuild 去生成 <code>.src.rpm</code> 包。</p>

<pre class="language-none"><code class="language-none">Name:       test
Version:    1.0.0
Release:    1%{?dist}
Summary:    hello

License:    Apache-2.0
URL:        https://xmake.io
Source0:    test-linux-src-v1.0.0.tar.gz

BuildRequires: xmake
BuildRequires: gcc
BuildRequires: gcc-c++

%description
A test installer.

%prep
%autosetup -n test-1.0.0 -p1

%build
xmake build -y test

%install
xmake install -o %{buildroot}/%{_exec_prefix} test
cd %{buildroot}
find . -type f | sed 's!^\./!/!' &gt; %{_builddir}/_installedfiles.txt

%check

%files -f %{_builddir}/_installedfiles.txt

%changelog
* Fri Dec 22 2023 ruki - 1.0.0-1
- Update to 1.0.0
</code></pre>
<p>我们也可以通过 <code>on_buildcmd</code> 和 <code>on_installcmd</code> 自定义构建和安装脚本。</p>

<pre class="language-lua"><code class="language-lua">xpack(&quot;test&quot;)
    set_homepage(&quot;https://xmake.io&quot;)
    set_license(&quot;Apache-2.0&quot;)
    set_description(&quot;A cross-platform build utility based on Lua.&quot;)

    set_formats(&quot;srpm&quot;)
    add_sourcefiles(&quot;(src/**)&quot;)
    add_sourcefiles(&quot;./configure&quot;)

    on_buildcmd(function (package, batchcmds)
        batchcmds:runv(&quot;./configure&quot;)
        batchcmds:runv(&quot;make&quot;)
    end)

    on_installcmd(function (package, batchcmds)
        batchcmds:runv(&quot;make&quot;, {&quot;install&quot;, &quot;PREFIX=%{buildroot}&quot;})
    end)
</code></pre>
<h3 id="%E7%94%9F%E6%88%90-RPM-%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85%E5%8C%85">生成 RPM 二进制安装包</h3>
<p>RPM 包将会直接生成编译好的二进制安装包。xmake 会自动调用 <code>rpmbuild --rebuild</code> 命令去构建 SRPM 包生成它。</p>
<p>而在 XPack 中，我们仅仅只需要配置 <code>set_formats(&quot;rpm&quot;)</code> 即可支持 rpm 包生成，其他配置与 srpm 包完全一致。</p>

<pre class="language-lua"><code class="language-lua">xpack(&quot;test&quot;)
    set_formats(&quot;rpm&quot;)
    -- TODO
</code></pre>
<h3 id="%E6%89%93%E5%8C%85%E5%91%BD%E4%BB%A4%E5%8F%82%E6%95%B0">打包命令参数</h3>
<h4 id="%E6%8C%87%E5%AE%9A%E6%89%93%E5%8C%85%E6%A0%BC%E5%BC%8F">指定打包格式</h4>
<p>如果我们在配置文件中已经使用 <code>set_formats</code> 配置了多个打包格式，那么默认情况下，<code>xmake pack</code> 会自动生成所有这些格式的包。</p>
<p>当然，我们也可以通过 <code>xmake pack --formats=nsis,targz</code> 来选择性指定当前需要打哪些格式的包。</p>
<h4 id="%E4%BF%AE%E6%94%B9%E6%89%93%E5%8C%85%E6%96%87%E4%BB%B6%E5%90%8D">修改打包文件名</h4>
<p>我们可以在配置文件中，通过 <code>set_basename()</code> 来修改包名，也可以通过命令行去修改它。</p>

<pre class="language-bash"><code class="language-bash">$ xmake pack --basename=&quot;foo&quot;
packing build/xpack/test/foo.zip ..
pack ok
</code></pre>
<h4 id="%E6%8C%87%E5%AE%9A%E8%BE%93%E5%87%BA%E7%9B%AE%E5%BD%95">指定输出目录</h4>
<p>默认的输出目录是在 build 目录下，但我们也可以修改输出的路径。</p>

<pre class="language-bash"><code class="language-bash">$ xmake pack -o /tmp/output
</code></pre>
<h4 id="%E7%A6%81%E7%94%A8%E8%87%AA%E5%8A%A8%E6%9E%84%E5%BB%BA">禁用自动构建</h4>
<p>如果是打 NSIS 等二进制包，<code>xmake pack</code> 会先自动编译所有被绑定的 target 目标文件，然后再去执行打包逻辑。</p>
<p>但是如果我们已经编译过了，不想每次都去编译它，而是直接去打包，可以通过下面的参数禁用自动构建。</p>

<pre class="language-bash"><code class="language-bash">$ xmake pack --autobuild=n
</code></pre>
<h3 id="%E6%8E%A5%E5%8F%A3%E6%8F%8F%E8%BF%B0">接口描述</h3>
<p>更多 XPack 打包接口描述见：<a href="https://xmake.io/#/zh-cn/manual/xpack"  target="_blank">XPack 打包接口文档</a>。</p>
<h2 id="%E5%AE%8F%E8%AE%B0%E5%BD%95%E5%92%8C%E5%9B%9E%E6%94%BE">宏记录和回放</h2>
<h3 id="%E7%AE%80%E4%BB%8B">简介</h3>
<p>我们可以通过这个插件，快速记录和回放我们平常频繁使用到的一些 xmake 操作，来简化我们日常的开发工作。</p>
<p>它提供了一些功能：</p>
<ul>
<li>手动记录和回放多条执行过的 xmake 命令</li>
<li>支持快速的匿名宏创建和回放</li>
<li>支持命名宏的长久记录和重用</li>
<li>支持宏脚本的批量导入和导出</li>
<li>支持宏脚本的删除、显示等管理功能</li>
<li>支持自定义高级宏脚本，以及参数配置</li>
</ul>
<h3 id="%E8%AE%B0%E5%BD%95%E6%93%8D%E4%BD%9C">记录操作</h3>

<pre class="language-console"><code class="language-console"># 开始记录宏
$ xmake macro --begin

# 执行一些 xmake 命令
$ xmake f -p android --ndk=/xxx/ndk -a arm64-v8a
$ xmake p
$ xmake f -p mingw --sdk=/mingwsdk
$ xmake p
$ xmake f -p linux --sdk=/toolsdk --toolchains=/xxxx/bin
$ xmake p
$ xmake f -p iphoneos -a armv7
$ xmake p
$ xmake f -p iphoneos -a arm64
$ xmake p
$ xmake f -p iphoneos -a armv7s
$ xmake p
$ xmake f -p iphoneos -a i386
$ xmake p
$ xmake f -p iphoneos -a x86_64
$ xmake p

# 结束宏记录，这里不设置宏名字，所以记录的是一个匿名宏
xmake macro --end
</code></pre>
<h3 id="%E5%9B%9E%E6%94%BE">回放</h3>

<pre class="language-console"><code class="language-console"># 回放一个匿名宏
$ xmake macro .
</code></pre>
<h3 id="%E5%91%BD%E5%90%8D%E5%AE%8F">命名宏</h3>
<p>匿名宏的好处就是快速记录，快速回放，如果需要长久保存，就需要给宏取个名字。</p>

<pre class="language-console"><code class="language-console">$ xmake macro --begin
$ ...
$ xmake macro --end macroname
$ xmake macro macroname
</code></pre>
<h3 id="%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA%E5%AE%8F">导入导出宏</h3>
<p>导入指定的宏脚本或者宏目录：</p>

<pre class="language-console"><code class="language-console">$ xmake macro --import=/xxx/macro.lua macroname
$ xmake macro --import=/xxx/macrodir
</code></pre>
<p>导出指定的宏到脚本或者目录：</p>

<pre class="language-console"><code class="language-console">$ xmake macro --export=/xxx/macro.lua macroname
$ xmake macro --export=/xxx/macrodir
</code></pre>
<h3 id="%E5%88%97%E4%B8%BE%E6%98%BE%E7%A4%BA%E5%AE%8F">列举显示宏</h3>
<p>列举所有 <code>xmake</code> 内置的宏脚本：</p>

<pre class="language-console"><code class="language-console">$ xmake macro --list
</code></pre>
<p>显示指定的宏脚本内容：</p>

<pre class="language-console"><code class="language-console">$ xmake macro --show macroname
</code></pre>
<h3 id="%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AE%8F%E8%84%9A%E6%9C%AC">自定义宏脚本</h3>
<p>我们也可以自己编写个宏脚本 <code>macro.lua</code> 然后导入到 xmake 中去。</p>

<pre class="language-lua"><code class="language-lua">function main()
    os.exec(&quot;xmake f -p android --ndk=/xxx/ndk -a arm64-v8a&quot;)
    os.exec(&quot;xmake p&quot;)
    os.exec(&quot;xmake f -p mingw --sdk=/mingwsdk&quot;)
    os.exec(&quot;xmake p&quot;)
    os.exec(&quot;xmake f -p linux --sdk=/toolsdk --toolchains=/xxxx/bin&quot;)
    os.exec(&quot;xmake p&quot;)
    os.exec(&quot;xmake f -p iphoneos -a armv7&quot;)
    os.exec(&quot;xmake p&quot;)
    os.exec(&quot;xmake f -p iphoneos -a arm64&quot;)
    os.exec(&quot;xmake p&quot;)
    os.exec(&quot;xmake f -p iphoneos -a armv7s&quot;)
    os.exec(&quot;xmake p&quot;)
    os.exec(&quot;xmake f -p iphoneos -a i386&quot;)
    os.exec(&quot;xmake p&quot;)
    os.exec(&quot;xmake f -p iphoneos -a x86_64&quot;)
    os.exec(&quot;xmake p&quot;)
end
</code></pre>
<p>导入到 xmake，并且定义宏名字：</p>

<pre class="language-console"><code class="language-console">$ xmake macro --import=/xxx/macro.lua [macroname]
</code></pre>
<p>回放这个宏脚本：</p>

<pre class="language-console"><code class="language-console">$ xmake macro [.|macroname]
</code></pre>
<h3 id="%E5%86%85%E7%BD%AE%E7%9A%84%E5%AE%8F%E8%84%9A%E6%9C%AC">内置的宏脚本</h3>
<p>XMake 提供了一些内置的宏脚本，来简化我们的日常开发工作。</p>
<p>例如，我们可以使用 <code>package</code> 宏来对 <code>iphoneos</code> 平台的所有架构，一次性批量构建和打包：</p>

<pre class="language-console"><code class="language-console">$ xmake macro package -p iphoneos
</code></pre>
<h3 id="%E9%AB%98%E7%BA%A7%E7%9A%84%E5%AE%8F%E8%84%9A%E6%9C%AC%E7%BC%96%E5%86%99">高级的宏脚本编写</h3>
<p>以上面提到的 <code>package</code> 宏为例，我们看下其具体代码，里面通过 <code>import</code> 导入一些扩展模块，实现了复杂的脚本操作。</p>

<pre class="language-lua"><code class="language-lua">-- imports
import(&quot;core.base.option&quot;)
import(&quot;core.project.config&quot;)
import(&quot;core.project.project&quot;)
import(&quot;core.platform.platform&quot;)

-- the options
local options =
{
    {'p', &quot;plat&quot;,       &quot;kv&quot;,  os.host(),   &quot;Set the platform.&quot;                                    }
,   {'f', &quot;config&quot;,     &quot;kv&quot;,  nil,         &quot;Pass the config arguments to \&quot;xmake config\&quot;..&quot;}
,   {'o', &quot;outputdir&quot;,  &quot;kv&quot;,  nil,         &quot;Set the output directory of the package.&quot;}
}

-- package all
--
-- .e.g
-- xmake m package
-- xmake m package -f &quot;-m debug&quot;
-- xmake m package -p linux
-- xmake m package -p iphoneos -f &quot;-m debug --xxx ...&quot; -o /tmp/xxx
-- xmake m package -f \&quot;--mode=debug\&quot;
--
function main(argv)

    -- parse arguments
    local args = option.parse(argv, options, &quot;Package all architectures for the given the platform.&quot;
                                           , &quot;&quot;
                                           , &quot;Usage: xmake macro package [options]&quot;)

    -- package all archs
    local plat = args.plat
    for _, arch in ipairs(platform.archs(plat)) do

        -- config it
        os.exec(&quot;xmake f -p %s -a %s %s -c %s&quot;, plat, arch, args.config or &quot;&quot;, (option.get(&quot;verbose&quot;) and&quot;-v&quot;or&quot;&quot;))

        -- package it
        if args.outputdir then
            os.exec(&quot;xmake p -o %s %s&quot;, args.outputdir, (option.get(&quot;verbose&quot;) and &quot;-v&quot; or &quot;&quot;))
        else
            os.exec(&quot;xmake p %s&quot;, (option.get(&quot;verbose&quot;) and &quot;-v&quot; or &quot;&quot;))
        end
    end

    -- package universal for iphoneos, watchos ...
    if plat == &quot;iphoneos&quot; or plat == &quot;watchos&quot; then

        -- load configure
        config.load()

        -- load project
        project.load()

        -- enter the project directory
        os.cd(project.directory())

        -- the outputdir directory
        local outputdir = args.outputdir or config.get(&quot;buildir&quot;)

        -- package all targets
        for _, target in pairs(project.targets()) do

            -- get all modes
            local modedirs = os.match(format(&quot;%s/%s.pkg/lib/*&quot;, outputdir, target:name()), true)
            for _, modedir in ipairs(modedirs) do

                -- get mode
                local mode = path.basename(modedir)

                -- make lipo arguments
                local lipoargs = nil
                for _, arch in ipairs(platform.archs(plat)) do
                    local archfile = format(&quot;%s/%s.pkg/lib/%s/%s/%s/%s&quot;, outputdir, target:name(), mode, plat, arch, path.filename(target:targetfile()))
                    if os.isfile(archfile) then
                        lipoargs = format(&quot;%s -arch %s %s&quot;, lipoargs or &quot;&quot;, arch, archfile)
                    end
                end
                if lipoargs then

                    -- make full lipo arguments
                    lipoargs = format(&quot;-create %s -output %s/%s.pkg/lib/%s/%s/universal/%s&quot;, lipoargs, outputdir, target:name(), mode, plat, path.filename(target:targetfile()))

                    -- make universal directory
                    os.mkdir(format(&quot;%s/%s.pkg/lib/%s/%s/universal&quot;, outputdir, target:name(), mode, plat))

                    -- package all archs
                    os.execv(&quot;xmake&quot;, {&quot;l&quot;, &quot;lipo&quot;, lipoargs})
                end
            end
        end
    end
end
</code></pre>
<p>!&gt; 如果你想要获取更多宏参数选项信息，请运行： <code>xmake macro --help</code></p>
<h2 id="%E7%94%9F%E6%88%90-doxygen-%E6%96%87%E6%A1%A3">生成 doxygen 文档</h2>
<p>请先确保本机已安装 <code>doxygen</code> 工具，然后在工程目录下运行：</p>

<pre class="language-console"><code class="language-console">$ xmake doxygen
</code></pre>

                        
                    </div>
                </div>
                <div id="previous_next">
                    <div id="previous">
                        
                        <a href="/get_started/zh/task/plugin-development.html">
                            <span class="icon"></span>
                            <span class="label">插件开发</span>
                        </a>
                        
                    </div>
                    <div id="next">
                        
                        <a href="/get_started/zh/module/builtin-modules.html">
                            <span class="label">内置模块</span>
                            <span class="icon"></span>
                        </a>
                        
                    </div>
                </div>
                <div id="comments-container"></div>
            </div>
            <div id="toc_wrapper">
                <div id="toc">
                    <div id="toc_content">
                            
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a id="to_top" href="#"></a>
    <div id="doc_footer">
        <div id="footer">
            <div id="footer_top">
                <ul>
<li><a>链接</a><ul><li><a target="_blank" href="https://teedoc.neucrack.com">使用 teedoc 构建</a></li>
<li><a  href="/sitemap.xml">网站地图</a></li>
</ul>
</li>
<li><a>源码</a><ul><li><a target="_blank" href="https://github.com/zxmake/zxmake.github.io">github</a></li>
<li><a target="_blank" href="https://github.com/zxmake/zxmake.github.io">gitee</a></li>
<li><a target="_blank" href="https://github.com/zxmake/zxmake.github.io">本网站源文件</a></li>
</ul>
</li>
</ul>

            </div>
            <div id="footer_bottom">
                <ul>
<li><a target="_blank" href="https://beian.miit.gov.cn">*ICP备********号</a></li>
<li><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=****************">*公网安备***********号</a></li>
</ul>

            </div>
        </div>
    </div>
    
        <script src="/teedoc-plugin-markdown-parser/mermaid.min.js"></script>
    
        <script>mermaid.initialize({startOnLoad:true});</script>
    
        <script src="/static/js/theme_default/tocbot.min.js"></script>
    
        <script src="/static/js/theme_default/main.js"></script>
    
        <script src="/static/js/theme_default/viewer.min.js"></script>
    
        <script src="/static/css/theme_default/prism.min.js"></script>
    
        <script src="/static/js/search/search_main.js"></script>
    
        <script src="/static/js/plugin_blog/main.js"></script>
    
        <script src="/static/js/custom.js"></script>
    
</body>

</html>