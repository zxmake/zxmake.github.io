<!DOCTYPE html>

<html lang="zh-CN"  class=" language_zh ">


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="keywords" content="">
    
    
    <meta name="description" content="">
    
    <meta name="generator" content="teedoc">
    <meta name="theme" content="teedoc-plugin-theme-default">
    
        
        <meta name="markdown-generator" content="teedoc-plugin-markdown-parser">
        
        <script>
MathJax = {"loader": {"load": ["output/svg"]}, "tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]]}, "svg": {"fontCache": "global"}};
</script>
        
        <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        
        <script src="/static/js/theme_default/pre_main.js"></script>
        
        <link rel="stylesheet" href="/static/css/theme_default/prism.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/theme_default/viewer.min.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/theme_default/dark.css" type="text/css"/>
        
        <link rel="stylesheet" href="/static/css/theme_default/light.css" type="text/css"/>
        
        <script src="/static/js/theme_default/jquery.min.js"></script>
        
        <script src="/static/js/theme_default/split.js"></script>
        
        <link rel="stylesheet" href="/static/css/search/style.css" type="text/css"/>
        
        <meta name="blog-generator" content="teedoc-plugin-blog">
        
        <link rel="stylesheet" href="/static/css/custom.css" type="text/css"/>
        
    
    
    <title>语法描述 - mysite</title>
    
    <script type="text/javascript">js_vars = {}</script>
    <script type="text/javascript">metadata = {"tags": [], "date": null, "update": [], "ts": 0, "author": "", "brief": "", "cover": ""}</script>
</head>


<body class="type_doc">
    
    <div id="navbar">
        <div id="navbar_menu">
            <a class="site_title" href="/">
                
                    <img class="site_logo" src="/static/image/logo-1600.png" alt="logo">
                
                
                    <h2>xmake</h2>
                
        </a>
            <a id="navbar_menu_btn"></a>
        </div>
        <div id="navbar_items">
            <div>
                <ul id="nav_left">
<li class=""><a  href="/get_started/zh/tutorial/quick-start.md">安装使用</a></li>
<li class=""><a  href="/dev/">开发文档</a></li>
</ul>

            </div>
            <div>
                <ul id="nav_right">
<li class=""><a target="_blank" href="https://github.com/neutree/teedoc">github</a></li>
<li class="sub_items "><a  >Language: 中文 简体</a><ul><li class=""><a  href="/get_started/en/tutorial/syntax-description.html">English</a></li>
<li class="active"><a  href="/get_started/zh/tutorial/syntax-description.html">中文 简体</a></li>
</ul></li>
</ul>

                <ul class="nav_plugins"><li><a id="themes" class="light"></a></li></ul><ul class="nav_plugins"><li><a id="search"><span class="icon"></span><span class="placeholder">搜索</span>
                            <div id="search_hints">
                                <span id="search_input_hint">输入关键词，多关键词空格隔开</span>
                                <span id="search_loading_hint">正在加载，请稍候。。。</span>
                                <span id="search_download_err_hint">下载文件失败，请刷新重试或检查网络</span>
                                <span id="search_other_docs_result_hint">来自其它文档的结果</span>
                                <span id="search_curr_doc_result_hint">当前文档搜索结果</span>
                            </div></a></li></ul>
            </div>
        </div>
    </div>
    
    <div id="wrapper">
        <div id="sidebar_wrapper">
            <div id="sidebar">
                <div id="sidebar_title">
                    
                </div>
                <ul class="show">
<li class="not_active no_link sidebar_category"><span class="label">新手教程</span></li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/install.html"><span class="label">安装</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/quick-start.html"><span class="label">快速入门</span><span class=""></span></a></li>
<li class="active with_link"><a href="/get_started/zh/tutorial/syntax-description.html"><span class="label">语法描述</span><span class="sub_indicator"></span></a><ul class="show">
<li class="not_active with_link"><a href="/get_started/zh/tutorial/description-scope.html"><span class="label">描述域</span><span class=""></span></a></li>
</ul>
</li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/project-examples.html"><span class="label">工程例子</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/configuration.html"><span class="label">配置说明</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/environment-variables.html"><span class="label">环境变量</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/build-policies.html"><span class="label">构建策略</span><span class=""></span></a></li>
<li class="not_active with_link"><a href="/get_started/zh/tutorial/FAQ.html"><span class="label">FAQ</span><span class=""></span></a></li>
<li class="not_active no_link sidebar_category"><span class="label">target 编译目标</span></li>
<li class="not_active no_link sidebar_category"><span class="label">option 选项</span></li>
<li class="not_active no_link sidebar_category"><span class="label">package 包管理</span></li>
<li class="not_active no_link sidebar_category"><span class="label">rule 规则</span></li>
<li class="not_active no_link sidebar_category"><span class="label">toolchain 工具链</span></li>
<li class="not_active no_link sidebar_category"><span class="label">plugin 插件</span></li>
<li class="not_active no_link sidebar_category"><span class="label">其他特性</span></li>
</ul>

            </div>
        </div>
        <div id="article">
            <div id="menu_wrapper">
                <div id="menu">
                </div>
            </div>
            <div id="content_wrapper">
                <div id="content_body">
                    <div id="article_head">
                        <div id="article_title">
                            
                            <h1>语法描述</h1>
                            
                        </div>
                        <div id="article_tags">
                            <ul>
                            
                            </ul>
                        </div>
                        <div id="article_info">
                        <div id="article_info_left">
                            <span class="article_author">
                                
                            </span>
                            
                                <span class="article_date" title="最后修改日期： 2025-02-26">
                                    2025-02-26
                                </span>
                            
                        </div>
                        <div id="article_info_right">
                            
                            <div id="source_link">
                                <a href="https://github.com/TOMO-CAT/xmake-teedoc/docs/get_started/zh/tutorial/syntax-description.md" target="_blank">
                                    编辑本页
                                </a>
                            </div>
                            
                        </div>
                        </div>
                    </div>
                    <div id="article_tools">
                        <span></span>
                        <span id="toc_btn"></span>
                    </div>
                    <div id="update_history">
                        
                    </div>
                    <div id="article_content">
                        
                            <p>xmake 的工程描述文件 xmake.lua 虽然基于 lua 语法，但是为了使得更加方便简洁得编写项目构建逻辑，xmake 对其进行了一层封装，使得编写 xmake.lua 不会像写 makefile 那样繁琐</p>
<p>基本上写个简单的工程构建描述，只需四行就能搞定，例如：</p>

<pre class="language-lua"><code class="language-lua">target(&quot;test&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
end)
</code></pre>
<h2 id="%E5%9F%9F%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95">域配置语法</h2>
<p>我们默认约定的域配置语法，尽管非常简洁，但是对自动格式化缩进和 IDE 不是很友好。</p>

<pre class="language-lua"><code class="language-lua">target(&quot;foo&quot;)
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.cpp&quot;)
target_end()
</code></pre>
<p>另外，它不能自动结束当前 target 作用域，用户需要显式调用 <code>target_end()</code>。</p>
<p>虽然，上面我们提到，可以使用 <code>do end</code> 模式来解决自动缩进问题，但是需要 <code>target_end()</code> 的问题还是存在。</p>

<pre class="language-lua"><code class="language-lua">target(&quot;bar&quot;) do
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.cpp&quot;)
end
target_end()
</code></pre>
<p>我们提供了一种更好的可选域配置语法，来解决自动缩进，target 域隔离问题，例如：</p>

<pre class="language-lua"><code class="language-lua">add_defines(&quot;ROOT&quot;)

target(&quot;foo&quot;, function ()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.cpp&quot;)
    add_defines(&quot;FOO&quot;)
end)

target(&quot;bar&quot;, function ()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.cpp&quot;)
    add_defines(&quot;BAR&quot;)
end)
</code></pre>
<p>foo 和 bar 两个域是完全隔离的，我们即使在它们中间配置其他设置，也不会影响它们，另外，它还对 LSP 非常友好。</p>
<blockquote>
<p>因此我们约定，xmake.lua 的域配置语法，默认采用可选的 <code>function () end</code> 模式，其他模式后续可能会被移除。</p>
</blockquote>
<h2 id="%E9%85%8D%E7%BD%AE%E5%88%86%E7%A6%BB">配置分离</h2>
<p>xmake.lua 采用二八原则实现了描述域、脚本域两层分离式配置。</p>
<p>什么是二八原则呢，简单来说，大部分项目的配置，80% 的情况下，都是些基础的常规配置，比如：<code>add_cxflags</code>, <code>add_links</code>等，<br />
只有剩下不到 20% 的地方才需要额外做些复杂来满足一些特殊的配置需求。</p>
<p>而这剩余的 20% 的配置通常比较复杂，如果直接充斥在整个 xmake.lua 里面，会把整个项目的配置整个很混乱，非常不可读。</p>
<p>因此，xmake 通过描述域、脚本域两种不同的配置方式，来隔离 80% 的简单配置以及 20% 的复杂配置，使得整个 xmake.lua 看起来非常的清晰直观，可读性和可维护性都达到最佳。</p>
<h3 id="%E6%8F%8F%E8%BF%B0%E5%9F%9F">描述域</h3>
<p>对于刚入门的新手用户，或者仅仅是维护一些简单的小项目，通过完全在描述配置就已经完全满足需求了，那什么是描述域呢？它长这样：</p>

<pre class="language-lua"><code class="language-lua">target(&quot;test&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
    add_defines(&quot;DEBUG&quot;)
    add_syslinks(&quot;pthread&quot;)
end)
</code></pre>
<p>一眼望去，其实就是个 <code>set_xxx</code>/<code>add_xxx</code> 的配置集，对于新手，完全可以不把它当做 lua 脚本，仅仅作为普通的，但有一些基础规则的配置文件就行了。</p>
<p>如果因为，看着有括号，还是像脚本语言的函数调用，那我们也可以这么写（是否带括号看个人喜好）：</p>

<pre class="language-lua"><code class="language-lua">target &quot;test&quot;
    set_kind &quot;binary&quot;
    add_files &quot;src/*.c&quot;
    add_defines &quot;DEBUG&quot;
    add_syslinks &quot;pthread&quot;
</code></pre>
<p>这是不是看着更像配置文件了？其实描述域就是配置文件，类似像 json 等 key/values 的配置而已，所以即使完全不会 lua 的新手，也是能很快上手的。</p>
<p>而且，对于通常的项目，仅通过 <code>set_xxx/add_xxx</code> 去配置各种项目设置，已经完全满足需求了。</p>
<p>这也就是开头说的：80% 的情况下，可以用最简单的配置规则去简化项目的配置，提高可读性和可维护性，这样对用户和开发者都会非常的友好，也更加直观。</p>
<p>如果我们要针对不同平台，架构做一些条件判断怎么办？没关系，描述域除了基础配置，也是支持条件判断，以及 for 循环的：</p>

<pre class="language-lua"><code class="language-lua">target(&quot;test&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
    add_defines(&quot;DEBUG&quot;)
    if is_plat(&quot;linux&quot;, &quot;macosx&quot;) then
        add_links(&quot;pthread&quot;, &quot;m&quot;, &quot;dl&quot;)
    end
end)
</code></pre>

<pre class="language-lua"><code class="language-lua">target(&quot;test&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
    add_defines(&quot;DEBUG&quot;)
    for _, name in ipairs({&quot;pthread&quot;, &quot;m&quot;, &quot;dl&quot;}) do
        add_links(name)
    end
end)
</code></pre>
<p>这是不是看着有点像 lua 了？虽说，平常可以把它当做普通配置问题，但是 xmake 毕竟基于 lua，所以描述域还是支持 lua 的基础语言特性的。</p>
<blockquote>
<p>不过需要注意的是，描述域虽然支持 lua 的脚本语法，但在描述域尽量不要写太复杂的 lua 脚本，比如一些耗时的函数调用和 for 循环</p>
</blockquote>
<p>并且在描述域，主要目的是为了设置配置项，因此 xmake 并没有完全开放所有的模块接口，很多接口在描述域是被禁止调用的，<br />
即使开放出来的一些可调用接口，也是完全只读的，不耗时的安全接口，比如：<code>os.getenv()</code> 等读取一些常规的系统信息，用于配置逻辑的控制。</p>
<blockquote>
<p>另外需要注意一点，xmake.lua 是会被多次解析的，用于在不同阶段解析不同的配置域：比如：<code>option()</code>, <code>target()</code> 等域。</p>
</blockquote>
<p>因此，不要想着在 xmake.lua 的描述域，写复杂的 lua 脚本，也<strong>不要在描述域调用 print 去显示信息，因为会被执行多遍</strong>。</p>
<h3 id="%E8%84%9A%E6%9C%AC%E5%9F%9F">脚本域</h3>
<p>限制描述域写复杂的 lua，各种 lua 模块和接口都用不了？怎么办？这个时候就是脚本域出场的时候了。</p>
<p>如果用户已经完全熟悉了 xmake 的描述域配置，并且感觉有些满足不了项目上的一些特殊配置维护了，那么我们可以在脚本域做更加复杂的配置逻辑：</p>

<pre class="language-lua"><code class="language-lua">target(&quot;test&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
    on_load(function (target)
        if is_plat(&quot;linux&quot;, &quot;macosx&quot;) then
            target:add(&quot;links&quot;, &quot;pthread&quot;, &quot;m&quot;, &quot;dl&quot;)
        end
    end)
    after_build(function (target)
        import(&quot;core.project.config&quot;)
        local targetfile = target:targetfile()
        os.cp(targetfile, path.join(config.buildir(), path.filename(targetfile)))
        print(&quot;build %s&quot;, targetfile)
    end)
end)
</code></pre>
<p>只要是类似：<code>on_xxx</code>, <code>after_xxx</code>, <code>before_xxx</code> 等字样的 function body 内部的脚本，都属于脚本域。</p>
<p>在脚本域中，用户可以干任何事，xmake 提供了 import 接口可以导入 xmake 内置的各种 lua 模块，也可以导入用户提供的 lua 脚本。</p>
<p>我们可以在脚本域实现你想实现的任意功能，甚至写个独立项目出来都是可以的。</p>
<p>对于一些脚本片段，不是很臃肿的话，像上面这么内置写写就足够了，如果需要实现更加复杂的脚本，不想充斥在一个 xmake.lua 里面，可以把脚本分离到独立的 lua 文件中去维护。</p>
<p>例如：</p>

<pre class="language-lua"><code class="language-lua">target(&quot;test&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
    on_load(&quot;modules.test.load&quot;)
    on_install(&quot;modules.test.install&quot;)
end)
</code></pre>
<p>我们可以把自定义的脚本放置到 xmake.lua 对应目录下，<code>modules/test/load.lua</code> 和 <code>modules/test/install.lua</code> 中独立维护。</p>
<p>这些独立的 lua 脚本里面，我们还可以通过<a href="/zh-cn/manual/builtin_modules?id=import"  >import</a>导入各种内置模块和自定义模块进来使用，就跟平常写lua, java 没啥区别。</p>
<p>而对于脚本的域的不同阶段，<code>on_load</code> 主要用于 target 加载时候，做一些动态化的配置（注意这里不像描述域，只会执行一遍）。</p>
<p>其他阶段，还有很多，比如：<code>on/after/before</code>_<code>build/install/package/run</code> 等，具体看下后面的 target api 手册部分吧，这里就不细说了。</p>
<h2 id="%E9%85%8D%E7%BD%AE%E7%B1%BB%E5%9E%8B">配置类型</h2>
<p>在描述域配置中，分配置域和配置项，配置域里面可以通过 <code>set_xxx</code>/<code>add_xxx</code> 的接口，配置各种配置项。</p>

<pre class="language-lua"><code class="language-lua">target(&quot;test1&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
end)

target(&quot;test2&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
end)
</code></pre>
<p>像上述配置中，target 就属于配置域，它下面的所有 <code>set_xx</code>/<code>add_xxx</code> 接口配置都属于配置项，对这个 target 局部生效。</p>
<p>我们可以把它理解成局部作用域，类似 c 里面的 block 块：</p>

<pre class="language-none"><code class="language-none">target(&quot;test1&quot;)
{
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
}
target(&quot;test2&quot;)
{
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
}
</code></pre>
<p>不过，为了简化写法，xmake 约定每个新定义的 target 域开始，上一个配置域就自动结束了，当然，如果这样用户觉得有困扰，也可以手动配置离开域：</p>

<pre class="language-lua"><code class="language-lua">target(&quot;test1&quot;)
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
target_end()

target(&quot;test2&quot;)
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
target_end()
</code></pre>
<h3 id="%E9%85%8D%E7%BD%AE%E5%9F%9F">配置域</h3>
<p>目前提供的配置域有：<code>target()</code>, <code>option()</code>, <code>task()</code>, <code>package()</code></p>
<p>每个域的详细说明，见：<a href="/zh-cn/manual/project_target"  >API手册</a></p>
<h3 id="%E9%85%8D%E7%BD%AE%E9%A1%B9">配置项</h3>
<p>只要是带有 <code>set_xxx</code> 和 <code>add_xxx</code> 字样的配置，都属于配置项，一个配置域里面可以设置多个配置项。</p>
<p>关于配置项的规范说明，见：<a href="/zh-cn/manual/specification"  >接口规范</a></p>
<h2 id="%E4%BD%9C%E7%94%A8%E5%9F%9F">作用域</h2>
<p>xmake 的描述语法是按作用域划分的，主要分为：</p>
<ul>
<li>外部作用域</li>
<li>内部作用域</li>
<li>接口作用域</li>
</ul>
<p>那哪些属于外部，哪些又属于内部呢，看看下面的注释，就知道个大概了：</p>

<pre class="language-lua"><code class="language-lua">-- 外部作用域
target(&quot;test&quot;, function()

    -- 外部作用域
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)

    on_run(function ()
        -- 内部作用域
        end)

    after_package(function ()
        -- 内部作用域
        end)
end)

-- 外部作用域
task(&quot;hello&quot;, function()

    -- 外部作用域
    on_run(function ()
        -- 内部作用域
        end)
end)
</code></pre>
<p>简单的说，就是在自定义脚本 <code>function () end</code> 之内的都属于内部作用域，也就是脚本作用域，其他地方都是都属于于外部作用域。。</p>
<h3 id="%E5%A4%96%E9%83%A8%E4%BD%9C%E7%94%A8%E5%9F%9F">外部作用域</h3>
<p>对于大部分工程来说，并不需要很复杂的工程描述，也不需要自定义脚本支持，只需要简单的 <code>set_xxx</code> 或者 <code>add_xxx</code> 就能满足需求了</p>
<p>那么根据二八定律，80% 的情况下，我们只需要这么写：</p>

<pre class="language-lua"><code class="language-lua">target(&quot;test&quot;, function()
    set_kind(&quot;static&quot;)
    add_files(&quot;src/test/*.c&quot;)
end)

target(&quot;demo&quot;, function()
    add_deps(&quot;test&quot;)
    set_kind(&quot;binary&quot;)
    add_links(&quot;test&quot;)
    add_files(&quot;src/demo/*.c&quot;)
end)
</code></pre>
<p>不需要复杂的 api 调用，也不需要各种繁琐的变量定义，以及 if 判断 和 for 循环，要的就是简洁可读，一眼看过去，就算不懂 lua 语法也没关系</p>
<p>就当做简单的描述语法，看上去有点像函数调用而已，会点编程的基本一看就知道怎么配置。</p>
<p>为了做到简洁、安全，在这个作用域内，很多 lua 内置 api 是不开放出来的，尤其是跟写文件、修改操作环境相关的，仅仅提供一些基本的只读接口，和逻辑操作</p>
<p>目前外部作用域开放的 lua 内置 api 有：</p>
<ul>
<li>table</li>
<li>string</li>
<li>pairs</li>
<li>ipairs</li>
<li>print</li>
<li>os</li>
</ul>
<p>当然虽然内置 lua api 提供不多，但 xmake 还提供了很多扩展 api，像描述 api 就不多说，详细可参考：<a href="/zh-cn/manual/builtin_modules"  >API手册</a></p>
<p>还有些辅助 api，例如：</p>
<ul>
<li>dirs：扫描获取当前指定路径中的所有目录</li>
<li>files：扫描获取当前指定路径中的所有文件</li>
<li>format: 格式化字符串，string.format 的简写版本</li>
</ul>
<p>还有变量定义、逻辑操作也是可以使用的，毕竟是基于 lua 的，该有的基础语法，还是要有的，我们可以通过 if 来切换编译文件：</p>

<pre class="language-lua"><code class="language-lua">target(&quot;test&quot;, function()
    set_kind(&quot;static&quot;)
    if is_plat(&quot;iphoneos&quot;) then
        add_files(&quot;src/test/ios/*.c&quot;)
    else
        add_files(&quot;src/test/*.c&quot;)
    end
end)
</code></pre>
<p>需要注意的是，变量定义分全局变量和局部变量，局部变量只对当前 xmake.lua 有效，不影响子 xmake.lua</p>

<pre class="language-lua"><code class="language-lua">-- 局部变量，只对当前xmake.lua有效
local var1 = 0

-- 全局变量，影响所有之后 includes() 包含的子 xmake.lua 
var2 = 1

includes(&quot;src&quot;)
</code></pre>
<h3 id="%E5%86%85%E9%83%A8%E4%BD%9C%E7%94%A8%E5%9F%9F">内部作用域</h3>
<p>也称插件、脚本作用域，提供更加复杂、灵活的脚本支持，一般用于编写一些自定义脚本、插件开发、自定义 task 任务、自定义模块等等</p>
<p>一般通过 <code>function () end</code> 包含，并且被传入到 <code>on_xxx</code>, <code>before_xxx</code> 和 <code>after_xxx</code> 接口内的，都属于自作用域。</p>
<p>例如：</p>

<pre class="language-lua"><code class="language-lua">-- 自定义脚本
target(&quot;hello&quot;, function()
    after_build(function ()
        -- 内部作用域
        end)
end)

-- 自定义任务、插件
task(&quot;hello&quot;, function()
    on_run(function ()
        -- 内部作用域
        end)
end)
</code></pre>
<p>在此作用域中，不仅可以使用大部分 lua 的 api，还可以使用很多 xmake 提供的扩展模块，所有扩展模块，通过 import 来导入</p>
<p>具体可参考：<a href="/zh-cn/manual/builtin_modules?id=import"  >import模块导入文档</a></p>
<p>这里我们给个简单的例子，在编译完成后，对 ios 目标程序进行 ldid 签名：</p>

<pre class="language-lua"><code class="language-lua">target(&quot;iosdemo&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;*.m&quot;)
    after_build(function (target)
        -- 执行签名，如果失败，自动中断，给出高亮错误信息
        os.run(&quot;ldid -S$(projectdir)/entitlements.plist %s&quot;, target:targetfile())
    end)
end)
</code></pre>
<p>需要注意的是，在内部作用域中，所有的调用都是启用异常捕获机制的，如果运行出错，会自动中断 xmake，并给出错误提示信息</p>
<p>因此，脚本写起来，不需要繁琐的 <code>if retval then</code> 判断，脚本逻辑更加一目了然</p>
<h3 id="%E6%8E%A5%E5%8F%A3%E4%BD%9C%E7%94%A8%E5%9F%9F">接口作用域</h3>
<p>在外部作用域中的所有描述api设置，本身也是有作用域之分的，在不同地方调用，影响范围也不相同，例如：</p>

<pre class="language-lua"><code class="language-lua">-- 全局根作用域，影响所有 target，包括 includes() 中的子工程 target 设置
add_defines(&quot;DEBUG&quot;)

-- 定义或者进入 demo 目标作用域（支持多次进入来追加设置）
target(&quot;demo&quot;, function()
    set_kind(&quot;shared&quot;)
    add_files(&quot;src/*.c&quot;)
    -- 当前 target 作用域，仅仅影响当前 target
    add_defines(&quot;DEBUG2&quot;)
end)

-- 选项设置，仅支持局部设置，不受全局 api 设置所影响
option(&quot;test&quot;, function()
    -- 当前选项的局部作用域
    set_default(false)
end)

-- 其他target设置，-DDEBUG 也会被设置上
target(&quot;demo2&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
end)

-- 重新进入demo目标作用域
target(&quot;demo&quot;, function()
    -- 追加宏定义，只对当前demo目标有效
    add_defines(&quot;DEBUG3&quot;)
end)
</code></pre>
<p>通常情况下，进入另一个 target/option 域设置，会自动离开上个 target/option 域，但是有时候为了比较一些作用域污染情况，我们可以显示离开某个域，例如：</p>

<pre class="language-lua"><code class="language-lua">option(&quot;test&quot;)
    set_default(false)
option_end()

target(&quot;demo&quot;)
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
target_end()
</code></pre>
<p>调用 <code>option_end()</code>, <code>target_end()</code> 即可显式的离开当前 target/option 域设置。</p>
<h3 id="%E4%BB%A3%E7%A0%81%E6%A0%BC%E5%BC%8F%E5%8C%96">代码格式化</h3>
<p>由于默认的描述域配置语法的缩进并不符合 lua 格式规范，因此 lua language server 是不支持对它进行格式化处理的。</p>
<p>如果想要让 IDE，编辑器更好的对配置进行格式化缩进支持，我么可以通过 <code>do end</code> 的写法来处理：</p>

<pre class="language-lua"><code class="language-lua">target(&quot;bar&quot;) do
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.cpp&quot;)
end

target(&quot;foo&quot;) do
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.cpp&quot;)
end
</code></pre>
<p>这样，Lua LSP 就能把它作为标准的 lua 代码进行正确的格式化，是否需要这么做，看用户自己的需求。</p>
<p>如果没有代码自动格式化的使用习惯，那就不需要这么做。</p>
<h2 id="%E5%A4%9A%E7%BA%A7%E9%85%8D%E7%BD%AE">多级配置</h2>
<p>在脚本域我们可以通过 import 导入各种丰富的扩展模块来使用，而在描述域我们可以通过<a href="/#/zh-cn/manual/global_interfaces?id=includes"  >includes</a>接口，来引入项目子目录下的 xmake.lua 配置。</p>
<p>记住：xmake 的 includes 是按照 tree 结构来处理配置关系的，子目录下的 xmake.lua 里面的 target 配置会继承父 xmake.lua 中的根域配置，例如：</p>
<p>目前有如下项目结构：</p>

<pre class="language-none"><code class="language-none">projectdir
    - xmake.lua
    - src
      - xmake.lua
</code></pre>
<p><code>projectdir/xmake.lua</code> 是项目的根 xmake.lua 配置，而 <code>src/xmake.lua</code> 是项目的子配置。</p>
<p><code>projectdir/xmake.lua</code> 内容：</p>

<pre class="language-lua"><code class="language-lua">add_defines(&quot;ROOT&quot;)

target(&quot;test1&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
    add_defines(&quot;TEST1&quot;)
end)

target(&quot;test2&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
    add_defines(&quot;TEST2&quot;)
end)

includes(&quot;src&quot;)
</code></pre>
<p>里面全局根域配置了 <code>add_defines(&quot;ROOT&quot;)</code>，会影响下面的所有 target 配置，包括 includes 里面子 xmake.lua 中的所有 target 配置，所以这个是全局总配置。</p>
<p>而在 test1/test2 里面的 <code>add_defines(&quot;TEST1&quot;)</code> 和 <code>add_defines(&quot;TEST2&quot;)</code> 属于局部配置，只对当前 target 生效。</p>
<p><code>src/xmake.lua</code> 内容：</p>

<pre class="language-lua"><code class="language-lua">add_defines(&quot;ROOT2&quot;)

target(&quot;test3&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
    add_defines(&quot;TEST3&quot;)
end)
</code></pre>
<p>在 <code>src/xmake.lua</code> 子配置中，也有个全局根域，配置了 <code>add_defines(&quot;ROOT2&quot;)</code>，这个属于子配置根域，只对当前子 xmake.lua 里面所有 target 生效，也会对下级 includes 里面的子 xmake.lua 中 target 生效，因为之前说了，xmake 是 tree 状结构的配置继承关系。</p>
<p>所以，这几个 target 的最终配置结果依次是：</p>

<pre class="language-none"><code class="language-none">target(&quot;test1&quot;): -DROOT -DTEST1
target(&quot;test2&quot;): -DROOT -DTEST2
target(&quot;test3&quot;): -DROOT -DROOT2 -DTEST3
</code></pre>
<h2 id="%E8%AF%AD%E6%B3%95%E7%AE%80%E5%8C%96">语法简化</h2>
<p>xmake.lua 的配置域语法，非常灵活，可以在相关域做各种复杂灵活的配置，但是对于许多精简的小块配置，这个时候就稍显冗余了：</p>

<pre class="language-lua"><code class="language-lua">option(&quot;test1&quot;, function()
    set_default(true)
    set_showmenu(true)
    set_description(&quot;test1 option&quot;)
end)

option(&quot;test2&quot;, function()
    set_default(true)
    set_showmeu(true)
end)

option(&quot;test3&quot;, function()
    set_default(&quot;hello&quot;)
end)
</code></pre>
<p>对于上面的这些小块 option 域设置，我们可以简化下成单行描述：</p>

<pre class="language-lua"><code class="language-lua">option(&quot;test1&quot;, {default = true, showmenu = true, description = &quot;test1 option&quot;})
option(&quot;test2&quot;, {default = true, showmenu = true})
option(&quot;test3&quot;, {default = &quot;hello&quot;})
</code></pre>
<p>除了 option 域，对于其他域也是支持这种简化写法的，例如：</p>

<pre class="language-lua"><code class="language-lua">target(&quot;demo&quot;, function()
    set_kind(&quot;binary&quot;)
    add_files(&quot;src/*.c&quot;)
end)
</code></pre>
<p>简化为：</p>

<pre class="language-lua"><code class="language-lua">target(&quot;demo&quot;, {kind = &quot;binary&quot;, files = &quot;src/*.c&quot;})
</code></pre>
<p>或者</p>

<pre class="language-lua"><code class="language-lua">target(&quot;demo&quot;, {
    kind = &quot;binary&quot;,
    files = &quot;src/*.c&quot;
})
</code></pre>
<p>当然，如果配置需求比较复杂的，还是原有的多行设置方式更加方便，这个就看自己的需求来评估到底使用哪种方式了。</p>

                        
                    </div>
                </div>
                <div id="previous_next">
                    <div id="previous">
                        
                        <a href="/get_started/zh/tutorial/quick-start.html">
                            <span class="icon"></span>
                            <span class="label">快速入门</span>
                        </a>
                        
                    </div>
                    <div id="next">
                        
                        <a href="/get_started/zh/tutorial/description-scope.html">
                            <span class="label">描述域</span>
                            <span class="icon"></span>
                        </a>
                        
                    </div>
                </div>
                <div id="comments-container"></div>
            </div>
            <div id="toc_wrapper">
                <div id="toc">
                    <div id="toc_content">
                            
                    </div>
                </div>
            </div>
        </div>
    </div>
    <a id="to_top" href="#"></a>
    <div id="doc_footer">
        <div id="footer">
            <div id="footer_top">
                <ul>
<li><a>链接</a><ul><li><a target="_blank" href="https://teedoc.neucrack.com">使用 teedoc 构建</a></li>
<li><a  href="/sitemap.xml">网站地图</a></li>
</ul>
</li>
<li><a>源码</a><ul><li><a target="_blank" href="https://github.com/neutree/teedoc">github</a></li>
<li><a target="_blank" href="https://gitee.com/teedoc/teedoc">gitee</a></li>
<li><a target="_blank" href="https://github.com/teedoc/teedoc.github.io">本网站源文件</a></li>
</ul>
</li>
</ul>

            </div>
            <div id="footer_bottom">
                <ul>
<li><a target="_blank" href="https://beian.miit.gov.cn">*ICP备********号</a></li>
<li><a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=****************">*公网安备***********号</a></li>
</ul>

            </div>
        </div>
    </div>
    
        <script src="/teedoc-plugin-markdown-parser/mermaid.min.js"></script>
    
        <script>mermaid.initialize({startOnLoad:true});</script>
    
        <script src="/static/js/theme_default/tocbot.min.js"></script>
    
        <script src="/static/js/theme_default/main.js"></script>
    
        <script src="/static/js/theme_default/viewer.min.js"></script>
    
        <script src="/static/css/theme_default/prism.min.js"></script>
    
        <script src="/static/js/search/search_main.js"></script>
    
        <script src="/static/js/plugin_blog/main.js"></script>
    
        <script src="/static/js/custom.js"></script>
    
</body>

</html>